<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis Permohonan Tahun 1 Sesi Akademik Tahun 2027, JPNS</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Support Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

  <!-- Recharts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
  
  <!-- Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>

  <!-- Firebase (Compat Mode) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- XLSX Library (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    body { 
      background-color: #f8fafc;
      background-image: 
        radial-gradient(at 0% 0%, rgba(220, 38, 38, 0.04) 0, transparent 40%),
        radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.04) 0, transparent 40%);
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: #1e293b;
      overflow-x: hidden;
      min-height: 100vh;
    }

    .premium-card {
      background: rgba(255, 255, 255, 1);
      border: 1px solid rgba(226, 232, 240, 1);
      box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
      border-radius: 1.5rem;
    }

    .glass-header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(226, 232, 240, 1);
      position: sticky; 
      top: 0;
      z-index: 50;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #dc2626;
      width: 45px;
      height: 45px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .active-tab {
      background: #0f172a !important;
      color: white !important;
      box-shadow: 0 8px 15px -3px rgba(15, 23, 42, 0.2);
    }

    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media print {
      body { background: white !important; -webkit-print-color-adjust: exact; padding: 0; margin: 0; }
      header, .no-print { display: none !important; }
      main { padding: 0; margin: 0; max-width: 100%; box-shadow: none; }
      .premium-card { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; border-radius: 0.5rem; overflow: visible !important; }
      .overflow-x-auto, .overflow-hidden { overflow: visible !important; }
      table { width: 100%; border-collapse: collapse; font-size: 10pt; }
      th, td { border: 1px solid #000 !important; padding: 8px !important; text-align: center; }
      .chart-container { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="text-align: center; padding-top: 150px;">
      <div class="loader"></div>
      <p style="color: #64748b; font-size: 15px; font-weight: 700; letter-spacing: 0.05em; font-family: 'Plus Jakarta Sans', sans-serif;">MENYEDIAKAN ANALISIS TAHUN 1...</p>
    </div>
  </div>

  <script type="text/babel">
    function initApp() {
      const { useState, useMemo, useEffect } = React;
      const RC = window.Recharts;

      const Chart = {
        BarChart: RC.BarChart, Bar: RC.Bar, XAxis: RC.XAxis, YAxis: RC.YAxis, 
        CartesianGrid: RC.CartesianGrid, Tooltip: RC.Tooltip, ResponsiveContainer: RC.ResponsiveContainer, 
        Legend: RC.Legend, Cell: RC.Cell, LabelList: RC.LabelList
      };

      const COHORT_NAMES = {
        C7: '7 Tahun (6+)',
        C6: '6 Tahun (5+)',
        LUAR: 'Luar Kohort'
      };

      const COHORT_RANGES_INT = {
        C7: { start: 20200102, end: 20210101 }, 
        C6: { start: 20210102, end: 20220101 }
      };

      const THEME = {
        male: '#3b82f6', // Blue
        female: '#ec4899', // Pink
        sk: '#1e40af',   // Dark Blue
        sjkc: '#b91c1c'  // Dark Red
      };

      const PPD_LIST = [
        "BARAM", "BAU", "BELAGA", "BETONG", "BINTULU", "DALAT", "DARO", 
        "JULAU", "KANOWIT", "KAPIT", "KUCHING", "LAWAS", "LIMBANG", 
        "LUBOK ANTU", "LUNDU", "MERADONG", "MIRI", "MUKAH", "PADAWAN", 
        "SAMARAHAN", "SARATOK", "SARIKEI", "SEBAUH", "SELANGAU", "SERIAN", "SIBU", 
        "SIMUNJAN", "SONG", "SRI AMAN", "SUBIS"
      ].sort();

      const firebaseConfig = {
        apiKey: "AIzaSyABRH2RUVWYB77uNXsk4BHuJw4IrtP3O3c",
        authDomain: "thn1jpn.firebaseapp.com",
        projectId: "thn1jpn",
        storageBucket: "thn1jpn.firebasestorage.app",
        messagingSenderId: "901531240540",
        appId: "1:901531240540:web:b49a624f2313ac5e493e99"
      };

      if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
      const db = firebase.firestore();
      const auth = firebase.auth();
      const appId = 'jpns-sarawak-2027-official';

      const Icon = ({ path, className = "w-5 h-5", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d={path} /></svg>
      );

      const Icons = {
        Upload: (p) => <Icon path="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" {...p} />,
        FileText: (p) => <Icon path="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" {...p} />,
        Users: (p) => <Icon path="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M23 21v-2a4 4 0 0 0-3-3.87" {...p} />,
        CheckCircle: (p) => <Icon path="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" {...p} />,
        Search: (p) => <Icon path="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM21 21l-4.35-4.35" {...p} />,
        Printer: (p) => <Icon path="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" {...p} />,
        Filter: (p) => <Icon path="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" {...p} />,
        Download: (p) => <Icon path="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1 M12 15l-4-4m4 4l4-4m-4 4V3" {...p} />,
        Trash2: (p) => <Icon path="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2 M10 11v6 M14 11v6" {...p} />,
        Info: (p) => <Icon path="M12 16h.01M12 12h.01M12 8h.01M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" {...p} />,
        XCircle: (p) => <Icon path="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M15 9l-6 6 M9 9l6 6" {...p} />,
        Copy: (p) => <Icon path="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" {...p} />,
        School: (p) => <Icon path="M22 22v-4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v4 M2 7h20 M6 7V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v3" {...p} />
      };

      const StatCard = ({ title, value, icon: IconComponent, colorClass }) => (
        <div className={`premium-card p-6 flex flex-col justify-center text-left border-l-8 ${colorClass}`}>
          <div className="flex justify-between items-center mb-4">
            <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">{title}</p>
            <div className="p-2.5 rounded-xl bg-slate-50 text-slate-700">
              <IconComponent className="w-5 h-5" />
            </div>
          </div>
          <h3 className="text-4xl font-extrabold text-slate-900 tracking-tight">{value}</h3>
        </div>
      );

      const Toast = ({ message, type, onClose }) => {
        useEffect(() => {
          const timer = setTimeout(onClose, 5000);
          return () => clearTimeout(timer);
        }, [onClose]);

        return (
          <div className="fixed top-6 right-6 z-[100] animate-fade-in font-['Plus Jakarta Sans'] no-print">
            <div className={`flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border-2 ${type === 'success' ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-red-600 border-red-500 text-white'}`}>
              <span className="text-sm font-bold tracking-tight text-center">{message}</span>
            </div>
          </div>
        );
      };

      const App = () => {
        const [data, setData] = useState([]);
        const [loading, setLoading] = useState(true);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [searchQuery, setSearchQuery] = useState(''); 
        const [manualPPD, setManualPPD] = useState('');
        const [user, setUser] = useState(null);
        const [toast, setToast] = useState(null);
        const [showPrintModal, setShowPrintModal] = useState(false);

        useEffect(() => {
          let isMounted = true;
          const initAuth = async () => {
            try { await auth.signInAnonymously(); } catch (err) { console.error("Auth Error", err); }
          };
          initAuth();
          const unsubscribe = auth.onAuthStateChanged(u => {
            if (isMounted) setUser(u);
            if (u) {
              const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
              return colRef.onSnapshot(snapshot => {
                if (isMounted) {
                  const combinedRows = [];
                  snapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData && docData.rows) combinedRows.push(...docData.rows);
                  });
                  setData(combinedRows);
                  setLoading(false);
                }
              }, (err) => { if (isMounted) setLoading(false); });
            } else { if (isMounted) setLoading(false); }
          });
          return () => { isMounted = false; unsubscribe(); };
        }, []);

        const allDataUnique = useMemo(() => {
          const merged = [];
          const seen = new Set();
          
          data.forEach(r => {
             if (r && (r.icClean || r.icFormatted || r.icRaw)) {
               const key = String(r.icClean || r.icFormatted || r.icRaw).replace(/[^0-9]/g, '');
               if (key && !seen.has(key)) {
                 seen.add(key);

                 let possibleSchool = r.sekolah || r.sekolahPilihan || r.namaSekolah || '';
                 if (!possibleSchool) {
                     for (let k in r) {
                         const kUpper = k.toUpperCase();
                         if (kUpper.includes('SEKOLAH') || kUpper.includes('PILIHAN1') || kUpper.includes('MOHON')) {
                             possibleSchool = r[k];
                             break;
                         }
                     }
                 }
                 
                 let sType = 'SK';
                 const rawSchoolName = String(possibleSchool || '').toUpperCase();
                 const normalizedSchool = rawSchoolName.replace(/[^A-Z0-9]/g, '');
                 if (normalizedSchool.includes('JENISKEBANGSAANCINA') || normalizedSchool.includes('SJKC') || normalizedSchool.includes('CINA') || normalizedSchool.includes('CHUNGHUA')) {
                     sType = 'SJK(C)';
                 }
                 
                 let jantinaClean = 'Perempuan'; 
                 if (key.length >= 12) {
                     const digitJantina = parseInt(key.substring(11, 12), 10);
                     if (!isNaN(digitJantina)) jantinaClean = (digitJantina % 2 !== 0) ? 'Lelaki' : 'Perempuan';
                 } else if (r.jantina) {
                     const jUpper = String(r.jantina).toUpperCase().trim();
                     if (jUpper.startsWith('L') || jUpper.includes('LELAKI')) jantinaClean = 'Lelaki';
                 }

                 let cohortClean = COHORT_NAMES.LUAR;
                 if (key.length >= 6) {
                     const yy = parseInt(key.substring(0, 2), 10), mm = parseInt(key.substring(2, 4), 10), dd = parseInt(key.substring(4, 6), 10);
                     if(!isNaN(yy) && !isNaN(mm) && !isNaN(dd)) {
                        const fullYear = yy >= 0 && yy <= 30 ? 2000 + yy : 1900 + yy;
                        const dobInt = parseInt(`${fullYear}${String(mm).padStart(2,'0')}${String(dd).padStart(2,'0')}`, 10);
                        if (dobInt >= COHORT_RANGES_INT.C7.start && dobInt <= COHORT_RANGES_INT.C7.end) cohortClean = COHORT_NAMES.C7;
                        else if (dobInt >= COHORT_RANGES_INT.C6.start && dobInt <= COHORT_RANGES_INT.C6.end) cohortClean = COHORT_NAMES.C6;
                     }
                 }

                 let ppdName = (r.ppd || 'SARAWAK').toUpperCase().replace(/^PPD\s+/i, '').trim();
                 merged.push({ ...r, icClean: key, jantina: jantinaClean, kohort: cohortClean, ppd: ppdName, jenisSekolah: sType });
               }
             }
          });
          return merged;
        }, [data]);

        const stats = useMemo(() => {
          const pool = allDataUnique;
          if(!pool.length) return { total: 0, cohortGenderData: [], genderData: [], schoolTypeData: [], ppdList: [] };

          const c7 = pool.filter(d => d.kohort === COHORT_NAMES.C7);
          const c6 = pool.filter(d => d.kohort === COHORT_NAMES.C6);

          const getC = (arr) => ({
            m: arr.filter(d => d.jantina === 'Lelaki').length,
            f: arr.filter(d => d.jantina === 'Perempuan').length,
            sk: arr.filter(d => d.jenisSekolah === 'SK').length,
            sjkc: arr.filter(d => d.jenisSekolah === 'SJK(C)').length
          });

          const c7s = getC(c7), c6s = getC(c6);
          const male = pool.filter(d => d.jantina === 'Lelaki').length;
          const female = pool.filter(d => d.jantina === 'Perempuan').length;
          const skTotal = pool.filter(d => d.jenisSekolah === 'SK').length;
          const sjkcTotal = pool.filter(d => d.jenisSekolah === 'SJK(C)').length;

          const ppdMap = pool.reduce((acc, r) => {
            const p = r.ppd || 'SARAWAK';
            if (!acc[p]) acc[p] = { name: p, total: 0, c7_l: 0, c7_p: 0, c7_sk: 0, c7_sjkc: 0, c6_l: 0, c6_p: 0, c6_sk: 0, c6_sjkc: 0 };
            acc[p].total++;
            const isM = r.jantina === 'Lelaki', isSK = r.jenisSekolah === 'SK';
            if (r.kohort === COHORT_NAMES.C7) { if (isM) acc[p].c7_l++; else acc[p].c7_p++; if (isSK) acc[p].c7_sk++; else acc[p].c7_sjkc++; }
            else if (r.kohort === COHORT_NAMES.C6) { if (isM) acc[p].c6_l++; else acc[p].c6_p++; if (isSK) acc[p].c6_sk++; else acc[p].c6_sjkc++; }
            return acc;
          }, {});

          // Data untuk carta kohort (termasuk divider visual)
          const cohortGenderData = [
            { name: '7 Tahun (6+)', Lelaki: c7s.m, Perempuan: c7s.f, divider: Math.max(c7s.m, c7s.f, c7s.sk, c7s.sjkc), SK: c7s.sk, 'SJK(C)': c7s.sjkc },
            { name: '6 Tahun (5+)', Lelaki: c6s.m, Perempuan: c6s.f, divider: Math.max(c6s.m, c6s.f, c6s.sk, c6s.sjkc), SK: c6s.sk, 'SJK(C)': c6s.sjkc }
          ];

          return {
            total: pool.length,
            cohortGenderData,
            genderData: [{ name: 'Lelaki', value: male, color: THEME.male }, { name: 'Perempuan', value: female, color: THEME.female }],
            schoolTypeData: [{ name: 'SK', value: skTotal, color: THEME.sk }, { name: 'SJK(C)', value: sjkcTotal, color: THEME.sjkc }],
            ppdList: Object.values(ppdMap).sort((a,b) => b.total - a.total)
          };
        }, [allDataUnique]);

        const filteredPPDList = useMemo(() => {
            if (!searchQuery) return stats.ppdList;
            const q = searchQuery.toLowerCase();
            return stats.ppdList.filter(p => p.name.toLowerCase().includes(q));
        }, [stats.ppdList, searchQuery]);

        const uploadedPPDs = new Set(allDataUnique.map(d => d.ppd));
        const sudahMuatNaik = PPD_LIST.filter(p => uploadedPPDs.has(p));
        const belumMuatNaik = PPD_LIST.filter(p => !uploadedPPDs.has(p));

        const handleProcessData = async (input, isExcel) => {
          setLoading(true);
          try {
            const rawRows = isExcel ? input : parseDataInputCSV(input);
            const updatedData = [...data];
            const icMap = new Map();
            updatedData.forEach((d, idx) => {
                const icClean = String(d.icFormatted || d.icClean || d.icRaw).replace(/[^0-9]/g,'');
                if (icClean) icMap.set(icClean, idx);
            });
            let added = 0, updated = 0;
            rawRows.forEach((r) => {
                let icRaw, name, jantinaRaw, ppd, sekolah;
                for(let key in r) {
                    const k = key.toUpperCase().replace(/[^A-Z0-9]/g,''); 
                    if (!icRaw && (k.includes('IC') || k.includes('MYKID') || k.includes('PENGENALAN'))) icRaw = r[key];
                    if (!name && (k.includes('NAMAMURID') || k === 'NAMA')) name = r[key];
                    if (!jantinaRaw && k.includes('JANTINA')) jantinaRaw = r[key];
                    if (!ppd && (k.includes('PPD') || k.includes('DAERAH'))) ppd = r[key];
                    if (!sekolah && (k.includes('SEKOLAHMOHON') || k.includes('PILIHAN1') || k.includes('SEKOLAH'))) sekolah = r[key];
                }
                if (!icRaw) return;
                const icClean = String(icRaw).replace(/[^0-9]/g, '');
                if (icClean.length < 6) return;
                const yy = parseInt(icClean.substring(0, 2), 10), mm = parseInt(icClean.substring(2, 4), 10), dd = parseInt(icClean.substring(4, 6), 10);
                const fullYear = yy >= 0 && yy <= 30 ? 2000 + yy : 1900 + yy;
                const dobInt = parseInt(`${fullYear}${String(mm).padStart(2,'0')}${String(dd).padStart(2,'0')}`);
                let coh = COHORT_NAMES.LUAR;
                if (dobInt >= COHORT_RANGES_INT.C7.start && dobInt <= COHORT_RANGES_INT.C7.end) coh = COHORT_NAMES.C7;
                else if (dobInt >= COHORT_RANGES_INT.C6.start && dobInt <= COHORT_RANGES_INT.C6.end) coh = COHORT_NAMES.C6;
                let gen = parseInt(icClean.substring(11, 12), 10) % 2 !== 0 ? 'Lelaki' : 'Perempuan';
                let ppdName = (manualPPD || ppd || 'SARAWAK').toUpperCase().replace(/^PPD\s+/i, '').trim();
                if (icMap.has(icClean)) {
                    const existingIdx = icMap.get(icClean);
                    if (sekolah) { updatedData[existingIdx].sekolah = sekolah; updated++; }
                } else {
                    updatedData.push({ nama: name || 'TANPA NAMA', ppd: ppdName, icFormatted: icRaw, jantina: gen, kohort: coh, sekolah: sekolah || '', tarikhLahir: `${dd}/${mm}/${fullYear}` });
                    icMap.set(icClean, updatedData.length - 1);
                    added++;
                }
            });
            if (added > 0 || updated > 0) {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan').doc('master').set({ rows: updatedData });
                setToast({ message: `Berjaya! ${added} rekod baharu, ${updated} dikemaskini.`, type: 'success' });
            } else setToast({ message: "Tiada penambahan dikesan.", type: 'error' });
          } catch(e) { setToast({ message: "Ralat memproses fail.", type: 'error' }); }
          setLoading(false);
        };

        const handleDownloadCSV = () => {
          if (!allDataUnique.length) return;
          const headers = ["PPD", "NAMA MURID", "NO MYKID", "TARIKH LAHIR", "JANTINA", "KOHORT", "JENIS SEKOLAH"];
          const csvRows = allDataUnique.map(d => [d.ppd, d.nama, d.icClean, d.tarikhLahir, d.jantina, d.kohort, d.jenisSekolah]);
          const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...csvRows.map(r => r.join(","))].join("\n");
          const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "Analisis_Sarawak_2027.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const handleCopyTable = () => {
          if (!filteredPPDList.length) return;
          const h = ["Bil", "Nama PPD", "Jum", "7L", "7P", "7SK", "7SJK", "7J", "6L", "6P", "6SK", "6SJK", "6J"];
          const rows = filteredPPDList.map((p, i) => [i + 1, p.name, p.total, p.c7_l, p.c7_p, p.c7_sk, p.c7_sjkc, p.c7_l + p.c7_p, p.c6_l, p.c6_p, p.c6_sk, p.c6_sjkc, p.c6_l + p.c6_p]);
          const tsv = [h.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
          const ta = document.createElement("textarea"); ta.value = tsv; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          setToast({ message: "Jadual disalin ke clipboard!", type: 'success' });
        };

        const handleResetData = async () => {
          if(window.confirm('Padam semua data dari awan secara kekal?')) { 
            try {
              setLoading(true);
              await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan').doc('master').delete();
              setData([]); setToast({ message: "Semua data dipadam.", type: 'success' });
            } catch (e) { setToast({ message: "Ralat memadam.", type: 'error' }); }
            finally { setLoading(false); }
          }
        };

        const handlePrint = () => { if (window.self !== window.top) setShowPrintModal(true); else window.print(); };

        if (loading && data.length === 0) return <div className="min-h-screen flex items-center justify-center flex-col"><div className="loader"></div><p className="mt-4 text-slate-500 font-bold text-sm uppercase tracking-widest italic font-['Plus Jakarta Sans']">Menyusun Data Sarawak...</p></div>;

        return (
          <div className="min-h-screen pb-10">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {showPrintModal && (
              <div className="fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm px-4 no-print">
                <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center animate-fade-in border border-slate-100">
                  <div className="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-5"><Icons.Printer className="w-8 h-8" /></div>
                  <h3 className="text-lg font-black text-slate-900 mb-2 uppercase tracking-tight">Cetak Laporan</h3>
                  <p className="text-xs text-slate-500 mb-6 font-bold leading-relaxed px-2">Gunakan pintasan papan kekunci pada skrin ini:</p>
                  <div className="flex justify-center gap-4 mb-8">
                    <div className="bg-slate-50 px-4 py-3 rounded-xl font-mono font-bold text-slate-800 border border-slate-200 shadow-inner text-xs">CTRL + P<br/><span className="text-[9px] text-slate-400 font-sans uppercase tracking-widest mt-1 block font-normal">Windows</span></div>
                    <div className="bg-slate-50 px-4 py-3 rounded-xl font-mono font-bold text-slate-800 border border-slate-200 shadow-inner text-xs">CMD + P<br/><span className="text-[9px] text-slate-400 font-sans uppercase tracking-widest mt-1 block font-normal">Mac</span></div>
                  </div>
                  <button onClick={() => setShowPrintModal(false)} className="w-full py-3 bg-slate-900 hover:bg-black text-white rounded-xl text-xs font-bold uppercase tracking-widest transition-colors shadow-lg">Tutup</button>
                </div>
              </div>
            )}

            <header className="glass-header px-10 py-6 flex justify-between items-center no-print">
              <div className="flex items-center gap-6">
                <div className="w-14 h-14 bg-red-600 text-white rounded-2xl flex items-center justify-center font-black text-xl shadow-lg">JPN</div>
                <div className="text-left">
                  <h1 className="text-xl font-extrabold text-slate-900 leading-none">ANALISIS PERMOHONAN TAHUN 1</h1>
                  <p className="text-sm font-semibold text-slate-500 uppercase tracking-widest mt-2">Sarawak â€¢ Sesi 2027</p>
                </div>
              </div>
              <button onClick={handlePrint} className="flex items-center gap-2 bg-slate-100 px-6 py-3 rounded-xl text-sm font-bold hover:bg-slate-200 border border-slate-200 transition-all text-slate-700 shadow-sm cursor-pointer"><Icons.Printer /> Cetak Laporan</button>
            </header>

            <main className="max-w-7xl mx-auto px-8 py-10 space-y-10 font-['Plus Jakarta Sans']">
              <div className="flex bg-white p-2 rounded-2xl shadow-sm border border-slate-200 w-fit no-print mx-auto">
                <button onClick={()=>setActiveTab('dashboard')} className={`px-10 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='dashboard'?'active-tab':'text-slate-500 hover:text-slate-800'}`}>DASHBOARD</button>
                <button onClick={()=>setActiveTab('list')} className={`px-10 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='list'?'active-tab':'text-slate-500 hover:text-slate-800'}`}>PENGURUSAN DATA</button>
                <button onClick={()=>setActiveTab('info')} className={`px-10 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='info'?'active-tab':'text-slate-500 hover:text-slate-800'}`}>INFO SISTEM</button>
              </div>

              {activeTab === 'dashboard' && (
                <div className="space-y-10 animate-fade-in">
                  <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-8">
                    <StatCard title="Jumlah Permohonan" value={stats.total.toLocaleString()} icon={Icons.FileText} colorClass="border-l-slate-800" />
                    
                    <div className="premium-card p-6 flex flex-col h-full col-span-1 lg:col-span-2">
                       <div className="flex justify-between items-center mb-6">
                          <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Analisis Kohort (Jantina vs Jenis Sekolah)</p>
                          <div className="p-2.5 rounded-xl bg-slate-50 text-slate-700"><Icons.Users /></div>
                       </div>
                       <div className="h-64 mt-2">
                         <Chart.ResponsiveContainer width="100%" height="100%">
                            <Chart.BarChart data={stats.cohortGenderData} margin={{top: 35, right: 10, left: 10, bottom: 0}} barGap={12}>
                               <Chart.CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0"/>
                               <Chart.XAxis dataKey="name" tick={{fontSize: 11, fontWeight: 800, fill: '#64748b'}} axisLine={false} tickLine={false} />
                               <Chart.Tooltip contentStyle={{borderRadius: '12px', border:'none', boxShadow:'0 4px 10px rgba(0,0,0,0.1)'}} />
                               <Chart.Legend verticalAlign="top" height={36} wrapperStyle={{fontSize: '11px', fontWeight: 'bold'}} />
                               
                               <Chart.Bar dataKey="Lelaki" fill={THEME.male} radius={[4,4,0,0]} barSize={14}>
                                  <Chart.LabelList dataKey="Lelaki" position="top" fontSize={10} fontWeight={800} fill={THEME.male} />
                               </Chart.Bar>
                               <Chart.Bar dataKey="Perempuan" fill={THEME.female} radius={[4,4,0,0]} barSize={14}>
                                  <Chart.LabelList dataKey="Perempuan" position="top" fontSize={10} fontWeight={800} fill={THEME.female} />
                               </Chart.Bar>
                               
                               {/* GARISAN PEMISAH VISUAL & JARAK */}
                               <Chart.Bar dataKey="divider" fill="#e2e8f0" barSize={1} legendType="none" tooltipType="none" opacity={0.5} />
                               
                               <Chart.Bar dataKey="SK" fill={THEME.sk} radius={[4,4,0,0]} barSize={14}>
                                  <Chart.LabelList dataKey="SK" position="top" fontSize={10} fontWeight={800} fill={THEME.sk} />
                               </Chart.Bar>
                               <Chart.Bar dataKey="SJK(C)" fill={THEME.sjkc} radius={[4,4,0,0]} barSize={14}>
                                  <Chart.LabelList dataKey="SJK(C)" position="top" fontSize={10} fontWeight={800} fill={THEME.sjkc} />
                               </Chart.Bar>
                            </Chart.BarChart>
                         </Chart.ResponsiveContainer>
                       </div>
                    </div>

                    <div className="premium-card p-6 flex flex-col h-full">
                       <div className="flex justify-between items-center mb-6">
                          <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Jantina Keseluruhan</p>
                          <div className="p-2.5 rounded-xl bg-slate-50 text-slate-700"><Icons.CheckCircle /></div>
                       </div>
                       <div className="h-64 mt-2">
                         <Chart.ResponsiveContainer width="100%" height="100%">
                            <Chart.BarChart data={stats.genderData} margin={{top: 35, right: 10, left: 10, bottom: 0}}>
                               <Chart.CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0"/>
                               <Chart.XAxis dataKey="name" tick={{fontSize: 11, fontWeight: 600, fill: '#64748b'}} axisLine={false} tickLine={false} />
                               <Chart.Bar dataKey="value" radius={[4,4,0,0]} barSize={32}>
                                  {stats.genderData.map((e, i) => <Chart.Cell key={i} fill={e.color} />)}
                                  <Chart.LabelList dataKey="value" position="top" fontSize={12} fontWeight={800} fill="#1e293b" />
                               </Chart.Bar>
                            </Chart.BarChart>
                         </Chart.ResponsiveContainer>
                       </div>
                    </div>
                  </div>

                  <div className="premium-card overflow-hidden bg-white">
                    <div className="p-8 border-b flex flex-col md:flex-row justify-between items-center gap-6 bg-slate-50/50 no-print">
                      <div className="text-left w-full md:w-auto">
                        <h3 className="text-base font-extrabold text-slate-900 uppercase tracking-widest">Rumusan Per Daerah Sarawak</h3>
                        <p className="text-xs font-semibold text-slate-500 mt-1 uppercase tracking-wider">Pecahan Bilangan Murid & Jenis Sekolah</p>
                      </div>
                      <div className="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center font-black">
                         <button onClick={handleCopyTable} className="w-full md:w-auto flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-[10px] font-bold text-slate-700 hover:bg-slate-50 hover:text-blue-600 transition-all shadow-sm uppercase tracking-widest"><Icons.Copy className="w-4 h-4" /> Salin Jadual</button>
                         <div className="relative w-full md:w-64 uppercase tracking-widest">
                            <Icons.Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                            <input type="text" placeholder="Cari Daerah PPD..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-[10px] font-bold text-slate-700 outline-none focus:ring-2 focus:ring-slate-800 transition-all shadow-sm" />
                         </div>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="min-w-full text-center uppercase font-bold text-[10px]">
                        <thead>
                          <tr>
                            <th rowSpan="2" className="border-r border-b px-4 py-4 text-slate-400 tracking-wider">Bil</th>
                            <th rowSpan="2" className="text-left border-r border-b px-6 py-4 text-slate-500 tracking-wider w-1/4">Nama PPD</th>
                            <th rowSpan="2" className="bg-slate-100/50 border-r border-b px-6 py-4 text-slate-900 tracking-wider">Jumlah</th>
                            <th colSpan="5" className="bg-orange-50/50 border-b border-r px-6 py-3 text-slate-600 tracking-wider">Kohort 7 Thn (6+)</th>
                            <th colSpan="5" className="bg-blue-50/50 border-b px-6 py-3 text-slate-600 tracking-wider">Kohort 6 Thn (5+)</th>
                          </tr>
                          <tr className="bg-slate-50/30 text-slate-500">
                             <th className="border-r border-b py-3 px-4">L</th><th className="border-r border-b py-3 px-4">P</th>
                             <th className="border-r border-b py-3 px-4 text-blue-700 bg-blue-50/30">SK</th><th className="border-r border-b py-3 px-4 text-red-700 bg-red-50/30">SJKC</th>
                             <th className="border-r border-b py-3 px-4 text-orange-700 bg-orange-50/50">Jum</th>
                             <th className="border-r border-b py-3 px-4">L</th><th className="border-r border-b py-3 px-4">P</th>
                             <th className="border-r border-b py-3 px-4 text-blue-700 bg-blue-50/30">SK</th><th className="border-r border-b py-3 px-4 text-red-700 bg-red-50/30">SJKC</th>
                             <th className="border-b py-3 px-4 text-blue-700 bg-blue-50/50">Jum</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 text-[11px]">
                          {filteredPPDList.map((p, i) => (
                            <tr key={p.name} className="hover:bg-slate-50/80 transition-colors">
                              <td className="text-slate-300 text-center border-r py-3.5">{i+1}</td>
                              <td className="text-left text-slate-800 font-black border-r py-3.5 px-6">{p.name}</td>
                              <td className="bg-slate-50/30 text-slate-950 border-r font-black py-3.5">{p.total}</td>
                              <td className="text-blue-600 border-r py-3.5 font-bold">{p.c7_l}</td><td className="text-pink-600 border-r py-3.5 font-bold">{p.c7_p}</td>
                              <td className="text-indigo-600 border-r py-3.5 bg-blue-50/10">{p.c7_sk}</td><td className="text-rose-600 border-r py-3.5 bg-red-50/10">{p.c7_sjkc}</td>
                              <td className="text-orange-700 border-r py-3.5 font-black bg-orange-50/30">{p.c7_l + p.c7_p}</td>
                              <td className="text-blue-600 border-r py-3.5 font-bold">{p.c6_l}</td><td className="text-pink-600 border-r py-3.5 font-bold">{p.c6_p}</td>
                              <td className="text-indigo-600 border-r py-3.5 bg-blue-50/10">{p.c6_sk}</td><td className="text-rose-600 border-r py-3.5 bg-red-50/10">{p.c6_sjkc}</td>
                              <td className="text-blue-700 py-3.5 font-black bg-blue-50/30">{p.c6_l + p.c6_p}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'list' && (
                <div className="max-w-3xl mx-auto space-y-10 no-print animate-fade-in uppercase font-black">
                  <div className="premium-card p-12 text-center space-y-8">
                    <div className="mb-8 w-full max-w-sm mx-auto">
                      <label className="block text-[10px] font-bold text-slate-400 tracking-widest mb-3 uppercase">Pilih Daerah Penghantar</label>
                      <select value={manualPPD} onChange={(e) => setManualPPD(e.target.value)} className="w-full px-6 py-4 bg-slate-50 text-xs font-black rounded-2xl border border-slate-200 outline-none focus:border-red-500 transition-all cursor-pointer text-center uppercase tracking-widest"><option value="">-- PILIH PPD --</option>{PPD_LIST.map(p => <option key={p} value={p}>{p}</option>)}</select>
                    </div>
                    <div className="relative group p-14 border-4 border-dashed border-slate-200 rounded-[3rem] hover:bg-slate-50 transition-all cursor-pointer">
                      <input type="file" accept=".csv,.xlsx,.xls" onChange={(e)=>{ const f = e.target.files[0]; if (f) { const isE = f.name.endsWith('.xlsx') || f.name.endsWith('.xls'); const r = new FileReader(); r.onload = (ev) => { if(isE) { const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); handleProcessData(rows, true); } else handleProcessData(ev.target.result, false); }; if(isE) r.readAsArrayBuffer(f); else r.readAsText(f); } }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                      <div className="w-20 h-20 bg-slate-900 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl"><Icons.Upload /></div>
                      <h3 className="text-xl font-black text-slate-900 leading-tight uppercase tracking-tight">MUAT NAIK FAIL DATA</h3>
                      <p className="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-2">Sokongan: Excel (.xlsx) atau CSV</p>
                    </div>
                    <div className="grid grid-cols-2 gap-6 pt-10 border-t border-slate-100">
                      <button onClick={handleDownloadCSV} className="bg-slate-900 text-white py-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-black transition-all flex items-center justify-center gap-3 shadow-lg"><Icons.Download /> Muat Turun CSV</button>
                      <button onClick={handleResetData} className="bg-red-50 text-red-600 py-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-red-100 transition-all border border-red-200 flex items-center justify-center gap-3"><Icons.Trash2 /> Kosongkan Data</button>
                    </div>
                  </div>
                  <div className="premium-card p-10 bg-white text-left font-['Plus Jakarta Sans'] font-bold uppercase">
                     <h3 className="text-sm font-bold text-slate-900 tracking-widest mb-8 border-b pb-4 flex items-center gap-3"><Icons.CheckCircle className="text-emerald-500 w-5 h-5"/> Status Penghantaran Data PPD</h3>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                       <div><h4 className="text-[10px] font-bold text-emerald-600 uppercase mb-4 tracking-widest">Sudah Muat Naik ({sudahMuatNaik.length}/30)</h4><div className="grid grid-cols-2 gap-3">{sudahMuatNaik.map(p => (<div key={p} className="text-[9px] font-bold text-slate-700 bg-emerald-50 py-2.5 px-3 rounded-lg border border-emerald-100 flex justify-between items-center">{p} <Icons.CheckCircle className="w-3 h-3 text-emerald-500" /></div>))}</div></div>
                       <div><h4 className="text-[10px] font-bold text-red-500 uppercase mb-4 tracking-widest">Belum Muat Naik ({belumMuatNaik.length}/30)</h4><div className="grid grid-cols-2 gap-3">{belumMuatNaik.map(p => (<div key={p} className="text-[9px] font-bold text-slate-500 bg-slate-50 py-2.5 px-3 rounded-lg border border-slate-100 flex justify-between items-center">{p} <Icons.XCircle className="w-3 h-3 text-red-300" /></div>))}</div></div>
                     </div>
                  </div>
                </div>
              )}

              {activeTab === 'info' && (
                <div className="max-w-4xl mx-auto animate-fade-in no-print font-['Plus Jakarta Sans'] font-bold uppercase">
                   <div className="premium-card p-12 space-y-10">
                      <div className="flex items-center gap-4 border-b border-slate-100 pb-8"><div className="w-14 h-14 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-800"><Icons.Info className="w-6 h-6"/></div><h2 className="text-2xl font-extrabold text-slate-900 tracking-tighter uppercase leading-none">Info & Integriti Sistem</h2></div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-10 text-[11px] leading-relaxed text-slate-600 text-left font-bold">
                         <div className="space-y-3"><h4 className="text-slate-900 tracking-widest uppercase">1. Konsolidasi Data Sarawak</h4><p>Sistem menggabungkan data permohonan dari setiap daerah Sarawak secara unik berasaskan No. MyKid murid. Ini menjamin statistik permohonan melebihi 6,000 rekod adalah tepat.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 tracking-widest uppercase">2. Analisis Kohort & Jenis Sekolah</h4><p>Carta kohort kini memisahkan kumpulan Jantina dan kumpulan Jenis Sekolah (SK/SJKC) menggunakan penunjuk visual garisan pemisah bagi memudahkan analisis pecahan murid.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 tracking-widest uppercase">3. Integriti Sarawak</h4><p>Status penghantaran dipaparkan bagi membolehkan pemantauan daerah yang melengkapkan data permohonan Tahun 1 bagi sesi 2027 secara telus.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 tracking-widest uppercase">4. Jantina Mutlak</h4><p>Logik sistem memproses jantina murid secara automatik berpandukan digit ke-12 No. MyKid (Ganjil=Lelaki, Genap=Perempuan) bagi menjamin ketepatan 100%.</p></div>
                      </div>
                   </div>
                </div>
              )}
            </main>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    }

    function parseDataInputCSV(text) {
        const lines = text.split(/\r\n|\n/);
        const headers = lines[0].split(lines[0].includes('\t') ? '\t' : ',').map(h => h.trim().replace(/^"|"$/g, ''));
        return lines.slice(1).map(line => {
            const cols = line.split(line.includes('\t') ? '\t' : ',');
            const obj = {};
            headers.forEach((h, i) => { obj[h] = cols[i] ? cols[i].trim().replace(/^"|"$/g, '') : ''; });
            return obj;
        });
    }

    window.onload = initApp;
  </script>
</body>
</html>
