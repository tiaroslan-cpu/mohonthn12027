<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analisis Permohonan Tahun 1 Sesi Akademik Tahun 2027, JPNS</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Support Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

  <!-- Recharts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
  
  <!-- Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>

  <!-- Firebase (Compat Mode) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- XLSX Library (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    body { 
      background-color: #f8fafc;
      background-image: 
        radial-gradient(at 0% 0%, rgba(220, 38, 38, 0.04) 0, transparent 40%),
        radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.04) 0, transparent 40%);
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: #1e293b;
      overflow-x: hidden;
      min-height: 100vh;
    }

    .premium-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
      border-radius: 1.5rem;
    }

    .glass-header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid #e2e8f0;
      position: sticky; 
      top: 0;
      z-index: 50;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #dc2626;
      width: 45px;
      height: 45px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .active-tab-btn {
      background: #0f172a;
      color: white;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }

    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media print {
      body { background: white !important; -webkit-print-color-adjust: exact; padding: 0; margin: 0; }
      header, .no-print { display: none !important; }
      main { padding: 0; margin: 0; max-width: 100%; box-shadow: none; }
      .premium-card { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; border-radius: 0.5rem; overflow: visible !important; }
      .overflow-x-auto, .overflow-hidden { overflow: visible !important; }
      table { width: 100%; border-collapse: collapse; font-size: 10pt; }
      th, td { border: 1px solid #000 !important; padding: 8px !important; text-align: center; }
      .action-col { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="text-align: center; padding-top: 150px;">
      <div class="loader"></div>
      <p style="color: #64748b; font-size: 15px; font-weight: 700; letter-spacing: 0.05em; font-family: 'Plus Jakarta Sans', sans-serif;">MENYEDIAKAN ANALISIS SARAWAK...</p>
    </div>
  </div>

  <script type="text/babel">
    function initApp() {
      const { useState, useMemo, useEffect } = React;
      const RC = window.Recharts;

      const Chart = {
        BarChart: RC.BarChart, Bar: RC.Bar, XAxis: RC.XAxis, YAxis: RC.YAxis, 
        CartesianGrid: RC.CartesianGrid, Tooltip: RC.Tooltip, ResponsiveContainer: RC.ResponsiveContainer, 
        Legend: RC.Legend, Cell: RC.Cell, LabelList: RC.LabelList
      };

      const COHORT_NAMES = {
        C7: '7 Tahun (6+)',
        C6: '6 Tahun (5+)',
        LUAR: 'Luar Kohort'
      };

      const COHORT_RANGES_INT = {
        C7: { start: 20200102, end: 20210101 }, 
        C6: { start: 20210102, end: 20220101 }
      };

      const THEME = {
        male: '#3b82f6', 
        female: '#ec4899'
      };

      const PPD_LIST = [
        "BARAM", "BAU", "BELAGA", "BETONG", "BINTULU", "DALAT", "DARO", 
        "JULAU", "KANOWIT", "KAPIT", "KUCHING", "LAWAS", "LIMBANG", 
        "LUBOK ANTU", "LUNDU", "MERADONG", "MIRI", "MUKAH", "PADAWAN", 
        "SAMARAHAN", "SARATOK", "SARIKEI", "SEBAUH", "SELANGAU", "SERIAN", "SIBU", 
        "SIMUNJAN", "SONG", "SRI AMAN", "SUBIS"
      ].sort();

      const firebaseConfig = {
        apiKey: "AIzaSyABRH2RUVWYB77uNXsk4BHuJw4IrtP3O3c",
        authDomain: "thn1jpn.firebaseapp.com",
        projectId: "thn1jpn",
        storageBucket: "thn1jpn.firebasestorage.app",
        messagingSenderId: "901531240540",
        appId: "1:901531240540:web:b49a624f2313ac5e493e99"
      };

      if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
      const db = firebase.firestore();
      const auth = firebase.auth();
      const appId = 'jpns-sarawak-2027-official';

      const Icon = ({ path, className = "w-5 h-5", ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d={path} /></svg>
      );

      const Icons = {
        Upload: (p) => <Icon path="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" {...p} />,
        FileText: (p) => <Icon path="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" {...p} />,
        Users: (p) => <Icon path="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M23 21v-2a4 4 0 0 0-3-3.87" {...p} />,
        CheckCircle: (p) => <Icon path="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" {...p} />,
        Search: (p) => <Icon path="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM21 21l-4.35-4.35" {...p} />,
        Printer: (p) => <Icon path="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" {...p} />,
        Download: (p) => <Icon path="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1 M12 15l-4-4m4 4l4-4m-4 4V3" {...p} />,
        Trash2: (p) => <Icon path="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2 M10 11v6 M14 11v6" {...p} />,
        Info: (p) => <Icon path="M12 16h.01M12 12h.01M12 8h.01M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" {...p} />,
        XCircle: (p) => <Icon path="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M15 9l-6 6 M9 9l6 6" {...p} />,
        ShieldAlert: (p) => <Icon path="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z M12 8v4 M12 16h.01" {...p} />,
        Copy: (p) => <Icon path="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" {...p} />,
        AlertTriangle: (p) => <Icon path="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" {...p} />
      };

      const StatCard = ({ title, value, icon: IconComponent, colorClass }) => (
        <div className={`premium-card p-6 flex flex-col justify-center text-left border-l-8 ${colorClass}`}>
          <div className="flex justify-between items-center mb-4">
            <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">{title}</p>
            <div className="p-2.5 rounded-xl bg-slate-50 text-slate-700">
              <IconComponent className="w-5 h-5" />
            </div>
          </div>
          <h3 className="text-4xl font-extrabold text-slate-900 tracking-tight">{value}</h3>
        </div>
      );

      const Toast = ({ message, type, onClose }) => {
        useEffect(() => { const timer = setTimeout(onClose, 5000); return () => clearTimeout(timer); }, [onClose]);
        return (
          <div className="fixed top-6 right-6 z-[200] animate-fade-in font-['Plus Jakarta Sans'] no-print">
            <div className={`flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border-2 ${type === 'success' ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-red-600 border-red-500 text-white'}`}>
              <span className="text-sm font-bold tracking-tight text-center">{message}</span>
            </div>
          </div>
        );
      };

      const ConfirmModal = ({ show, title, message, onConfirm, onCancel, confirmText = "Sahkan", type = "danger" }) => {
        if (!show) return null;
        return (
          <div className="fixed inset-0 z-[300] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in no-print">
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden p-8 text-center space-y-6">
              <div className={`mx-auto w-16 h-16 rounded-full flex items-center justify-center ${type === 'danger' ? 'bg-red-50 text-red-600' : 'bg-orange-50 text-orange-600'}`}>
                {type === 'danger' ? <Icons.Trash2 className="w-8 h-8"/> : <Icons.AlertTriangle className="w-8 h-8"/>}
              </div>
              <div className="space-y-2">
                <h3 className="text-xl font-black text-slate-900 uppercase tracking-tight">{title}</h3>
                <p className="text-sm text-slate-500 font-bold leading-relaxed">{message}</p>
              </div>
              <div className="flex gap-3">
                <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all">Batal</button>
                <button onClick={onConfirm} className={`flex-1 py-3 text-white rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg ${type === 'danger' ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-slate-900 hover:bg-black shadow-slate-200'}`}>{confirmText}</button>
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [data, setData] = useState([]); 
        const [loading, setLoading] = useState(true);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [searchQuery, setSearchQuery] = useState(''); 
        const [manualPPD, setManualPPD] = useState('');
        const [user, setUser] = useState(null);
        const [toast, setToast] = useState(null);
        
        // Modal states
        const [deleteConfirm, setDeleteConfirm] = useState({ show: false, ppd: null });
        const [resetConfirm, setResetConfirm] = useState(false);
        const [cleanupConfirm, setCleanupConfirm] = useState(false);

        useEffect(() => {
          let isMounted = true;
          const initAuth = async () => { try { await auth.signInAnonymously(); } catch (err) { console.error("Auth Error", err); } };
          initAuth();
          const unsubscribe = auth.onAuthStateChanged(u => {
            if (isMounted) setUser(u);
            if (u) {
              const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
              return colRef.onSnapshot(snapshot => {
                if (isMounted) {
                  const combinedRows = [];
                  snapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData) {
                      if (docData.rows && Array.isArray(docData.rows)) {
                        combinedRows.push(...docData.rows);
                      } else {
                        combinedRows.push(docData);
                      }
                    }
                  });
                  setData(combinedRows);
                  setLoading(false);
                }
              }, (err) => { if (isMounted) setLoading(false); });
            } else { if (isMounted) setLoading(false); }
          });
          return () => { isMounted = false; unsubscribe(); };
        }, []);

        const allDataUnique = useMemo(() => {
          const merged = [];
          const seen = new Set();
          
          data.forEach(r => {
             if (r && (r.icClean || r.icFormatted || r.icRaw)) {
               const key = String(r.icClean || r.icFormatted || r.icRaw).replace(/[^0-9]/g, '');
               if (key && !seen.has(key)) {
                 seen.add(key);
                 let jantinaClean = 'Perempuan'; 
                 if (key.length >= 12) {
                     const digitJantina = parseInt(key.substring(11, 12), 10);
                     if (!isNaN(digitJantina)) jantinaClean = (digitJantina % 2 !== 0) ? 'Lelaki' : 'Perempuan';
                 }
                 let cohortClean = COHORT_NAMES.LUAR;
                 if (key.length >= 6) {
                     const yy = parseInt(key.substring(0, 2), 10), mm = parseInt(key.substring(2, 4), 10), dd = parseInt(key.substring(4, 6), 10);
                     if(!isNaN(yy) && !isNaN(mm) && !isNaN(dd)) {
                        const fullYear = yy >= 0 && yy <= 30 ? 2000 + yy : 1900 + yy;
                        const dobInt = parseInt(`${fullYear}${String(mm).padStart(2,'0')}${String(dd).padStart(2,'0')}`, 10);
                        if (dobInt >= COHORT_RANGES_INT.C7.start && dobInt <= COHORT_RANGES_INT.C7.end) cohortClean = COHORT_NAMES.C7;
                        else if (dobInt >= COHORT_RANGES_INT.C6.start && dobInt <= COHORT_RANGES_INT.C6.end) cohortClean = COHORT_NAMES.C6;
                     }
                 }
                 let ppdName = r.ppd || 'SARAWAK';
                 ppdName = ppdName.toUpperCase().replace(/^PPD\s+/i, '').trim();
                 merged.push({ ...r, icClean: key, jantina: jantinaClean, kohort: cohortClean, ppd: ppdName });
               }
             }
          });
          return merged;
        }, [data]);

        const stats = useMemo(() => {
          const pool = allDataUnique;
          const defaultCohort = { c7_m: 0, c7_p: 0, c7_total: 0, c6_m: 0, c6_p: 0, c6_total: 0, total_m: 0, total_p: 0, grand_total: 0 };
          if(!pool.length) return { total: 0, genderData: [], ppdList: [], cohortValues: defaultCohort };

          const c7 = pool.filter(d => d.kohort === COHORT_NAMES.C7);
          const c6 = pool.filter(d => d.kohort === COHORT_NAMES.C6);
          const c7_m = c7.filter(d => d.jantina === 'Lelaki').length;
          const c7_p = c7.filter(d => d.jantina === 'Perempuan').length;
          const c6_m = c6.filter(d => d.jantina === 'Lelaki').length;
          const c6_p = c6.filter(d => d.jantina === 'Perempuan').length;
          const male = pool.filter(d => d.jantina === 'Lelaki').length;
          const female = pool.filter(d => d.jantina === 'Perempuan').length;

          const ppdGroups = {};
          pool.forEach(r => {
            const p = r.ppd || 'TIADA MAKLUMAT';
            if (!ppdGroups[p]) ppdGroups[p] = { name: p, total: 0, c7_l: 0, c7_p: 0, c6_l: 0, c6_p: 0 };
            ppdGroups[p].total++;
            const isM = r.jantina === 'Lelaki';
            if (r.kohort === COHORT_NAMES.C7) { if (isM) ppdGroups[p].c7_l++; else ppdGroups[p].c7_p++; }
            else if (r.kohort === COHORT_NAMES.C6) { if (isM) ppdGroups[p].c6_l++; else ppdGroups[p].c6_p++; }
          });

          return {
            total: pool.length,
            cohortValues: { c7_m, c7_p, c7_total: c7_m + c7_p, c6_m, c6_p, c6_total: c6_m + c6_p, total_m: male, total_p: female, grand_total: pool.length },
            genderData: [{ name: 'Lelaki', value: male, color: THEME.male }, { name: 'Perempuan', value: female, color: THEME.female }],
            ppdList: Object.values(ppdGroups).sort((a,b) => b.total - a.total)
          };
        }, [allDataUnique]);

        const filteredPPDList = useMemo(() => {
            if (!searchQuery) return stats.ppdList;
            const q = searchQuery.toLowerCase();
            return stats.ppdList.filter(p => p.name.toLowerCase().includes(q));
        }, [stats.ppdList, searchQuery]);

        const uploadedPPDs = useMemo(() => new Set(allDataUnique.map(d => d.ppd)), [allDataUnique]);
        const sudahMuatNaik = useMemo(() => PPD_LIST.filter(p => uploadedPPDs.has(p)), [uploadedPPDs]);
        const belumMuatNaik = useMemo(() => PPD_LIST.filter(p => !uploadedPPDs.has(p)), [uploadedPPDs]);

        const handleCleanupData = async () => {
          setLoading(true);
          try {
             const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
             const snapshot = await colRef.get();
             const batch = db.batch();
             let count = 0;
             snapshot.forEach(doc => {
                if (doc.id !== 'master' && !PPD_LIST.includes(doc.data()?.ppd)) { batch.delete(doc.ref); count++; }
             });
             if (count > 0) { await batch.commit(); setToast({ message: `Berjaya membersihkan ${count} rekod tidak sah.`, type: 'success' }); }
             else { setToast({ message: "Tiada data tidak sah dikesan.", type: 'success' }); }
          } catch(e) { setToast({ message: "Ralat pembersihan data.", type: 'error' }); }
          setLoading(false); setCleanupConfirm(false);
        };

        const handleProcessData = async (input, isExcel) => {
          if (!manualPPD) { setToast({ message: "Sila pilih daerah PPD terlebih dahulu!", type: 'error' }); return; }
          setLoading(true);
          try {
            const rawRows = isExcel ? input : parseDataInputCSV(input);
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
            const existingIcs = new Set(allDataUnique.map(d => d.icClean));
            let added = 0; let rowsToUpload = [];

            rawRows.forEach((r) => {
                let icRaw, name;
                for(let key in r) {
                    const k = key.toUpperCase().replace(/[^A-Z0-9]/g,''); 
                    if (!icRaw && (k.includes('IC') || k.includes('MYKID') || k.includes('PENGENALAN'))) icRaw = r[key];
                    if (!name && (k.includes('NAMAMURID') || k === 'NAMA')) name = r[key];
                }
                if (!icRaw) return;
                const icClean = String(icRaw).replace(/[^0-9]/g, '');
                if (icClean.length < 6 || existingIcs.has(icClean)) return;

                const yy = parseInt(icClean.substring(0, 2), 10), mm = parseInt(icClean.substring(2, 4), 10), dd = parseInt(icClean.substring(4, 6), 10);
                const fullYear = yy >= 0 && yy <= 30 ? 2000 + yy : 1900 + yy;
                let coh = COHORT_NAMES.LUAR;
                const dobInt = parseInt(`${fullYear}${String(mm).padStart(2,'0')}${String(dd).padStart(2,'0')}`);
                if (dobInt >= COHORT_RANGES_INT.C7.start && dobInt <= COHORT_RANGES_INT.C7.end) coh = COHORT_NAMES.C7;
                else if (dobInt >= COHORT_RANGES_INT.C6.start && dobInt <= COHORT_RANGES_INT.C6.end) coh = COHORT_NAMES.C6;

                const gen = parseInt(icClean.substring(11, 12), 10) % 2 !== 0 ? 'Lelaki' : 'Perempuan';
                rowsToUpload.push({ nama: name || 'TANPA NAMA', ppd: manualPPD, icFormatted: icRaw, icClean: icClean, jantina: gen, kohort: coh, tarikhLahir: `${dd}/${mm}/${fullYear}` });
                existingIcs.add(icClean); added++;
            });

            if (added > 0) {
                for (let i = 0; i < rowsToUpload.length; i += 500) {
                    const batch = db.batch(); const chunk = rowsToUpload.slice(i, i + 500);
                    chunk.forEach(row => batch.set(colRef.doc(row.icClean), row));
                    await batch.commit();
                }
                setToast({ message: `Berjaya menambah ${added} rekod murid bagi PPD ${manualPPD}.`, type: 'success' });
            } else { setToast({ message: "Tiada rekod baharu dikesan.", type: 'error' }); }
          } catch(e) { setToast({ message: "Ralat memproses fail.", type: 'error' }); }
          setLoading(false);
        };

        const handleDownloadCSV = () => {
          if (!allDataUnique.length) return;
          const headers = ["PPD", "NAMA MURID", "NO MYKID", "TARIKH LAHIR", "JANTINA", "KOHORT"];
          const csvRows = allDataUnique.map(d => [d.ppd, d.nama, d.icClean, d.tarikhLahir, d.jantina, d.kohort]);
          const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...csvRows.map(r => r.join(","))].join("\n");
          const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
          link.setAttribute("download", "Analisis_Sarawak_2027.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const handleCopyTable = () => {
          if (!filteredPPDList.length) return;
          const headers = ["Bil", "Nama PPD", "Jumlah", "7L", "7P", "7Jum", "6L", "6P", "6Jum"];
          const tsv = [headers.join('\t'), ...filteredPPDList.map((p, i) => [i + 1, p.name, p.total, p.c7_l, p.c7_p, p.c7_l + p.c7_p, p.c6_l, p.c6_p, p.c6_l + p.c6_p].join('\t'))].join('\n');
          const ta = document.createElement("textarea"); ta.value = tsv; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          setToast({ message: "Jadual rumusan disalin!", type: 'success' });
        };

        const handleDeletePPD = async (ppdName) => {
          setLoading(true);
          try {
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
            const snapshot = await colRef.where('ppd', '==', ppdName).get();
            const batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            setToast({ message: `Data PPD ${ppdName} telah dipadam.`, type: 'success' });
          } catch (e) { setToast({ message: "Gagal memadam data.", type: 'error' }); }
          finally { setLoading(false); setDeleteConfirm({ show: false, ppd: null }); }
        };

        const handleResetData = async () => {
          setLoading(true);
          try {
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('permohonan');
            const snapshot = await colRef.get();
            const docs = snapshot.docs;
            for (let i = 0; i < docs.length; i += 500) {
              const batch = db.batch(); const chunk = docs.slice(i, i + 500);
              chunk.forEach(doc => batch.delete(doc.ref)); await batch.commit();
            }
            setData([]); setToast({ message: "Semua data murid dipadam.", type: 'success' });
          } catch (e) { setToast({ message: "Ralat memadam data.", type: 'error' }); }
          finally { setLoading(false); setResetConfirm(false); }
        };

        if (loading && data.length === 0) return (
            <div className="min-h-screen flex items-center justify-center flex-col animate-pulse">
              <div className="loader"></div>
              <p className="mt-4 text-slate-500 font-black text-[10px] uppercase tracking-[0.3em] italic">Menyusun Data Sarawak...</p>
            </div>
        );

        return (
          <div className="min-h-screen pb-10">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            
            {/* Confirmation Modals */}
            <ConfirmModal 
              show={deleteConfirm.show} 
              title="Hapuskan Data?" 
              message={`Adakah anda pasti mahu memadam semua rekod murid bagi PPD ${deleteConfirm.ppd}? Tindakan ini tidak boleh dibatalkan.`}
              onConfirm={() => handleDeletePPD(deleteConfirm.ppd)}
              onCancel={() => setDeleteConfirm({ show: false, ppd: null })}
            />
            <ConfirmModal 
              show={resetConfirm} 
              title="Padam Semua Data?" 
              message="Anda akan memadam SELURUH pangkalan data murid di Sarawak. Pastikan anda mempunyai salinan fail asal."
              onConfirm={handleResetData}
              onCancel={() => setResetConfirm(false)}
            />
            <ConfirmModal 
              show={cleanupConfirm} 
              title="Bersihkan Data?" 
              message="Sistem akan mencari dan memadam rekod 'sampah' yang tiada pengenalan PPD sah. Rekod murid sedia ada selamat."
              confirmText="Bersihkan"
              type="warning"
              onConfirm={handleCleanupData}
              onCancel={() => setCleanupConfirm(false)}
            />

            <header className="glass-header px-10 py-6 flex flex-col md:flex-row justify-between items-center gap-6 no-print">
              <div className="flex items-center gap-6">
                <div className="w-14 h-14 bg-red-600 text-white rounded-2xl flex items-center justify-center font-black text-xl shadow-lg">JPNS</div>
                <div className="text-left"><h1 className="text-xl font-extrabold text-slate-900 leading-none uppercase">Analisis Permohonan Tahun 1</h1><p className="text-sm font-semibold text-slate-500 uppercase tracking-widest mt-2">Sarawak â€¢ Sesi 2027</p></div>
              </div>
              <div className="flex bg-slate-100 p-1.5 rounded-2xl w-fit font-black uppercase text-[10px]">
                 <button onClick={()=>setActiveTab('dashboard')} className={`px-10 py-3 rounded-[1.2rem] transition-all ${activeTab==='dashboard'?'active-tab-btn':'text-slate-400'}`}>DASHBOARD</button>
                 <button onClick={()=>setActiveTab('list')} className={`px-10 py-3 rounded-[1.2rem] transition-all ${activeTab==='list'?'active-tab-btn':'text-slate-400'}`}>PENGURUSAN DATA</button>
                 <button onClick={()=>setActiveTab('info')} className={`px-10 py-3 rounded-[1.2rem] transition-all ${activeTab==='info'?'active-tab-btn':'text-slate-400'}`}>INFO SISTEM</button>
              </div>
              <button onClick={()=>window.print()} className="flex items-center gap-2 bg-slate-100 px-6 py-3 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all shadow-sm"><Icons.Printer /> Cetak Laporan</button>
            </header>

            <main className="max-w-7xl mx-auto px-8 py-10 space-y-10 font-['Plus Jakarta Sans'] text-center">
              {activeTab === 'dashboard' && (
                <div className="space-y-10 animate-fade-in">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <StatCard title="Jumlah Permohonan" value={stats.total.toLocaleString()} icon={Icons.FileText} colorClass="border-l-slate-800" />
                    <div className="premium-card p-6 flex flex-col h-full">
                       <div className="flex justify-between items-center mb-6"><p className="text-sm font-bold text-slate-500 uppercase tracking-wider text-left">Analisis Kohort</p><div className="p-2.5 rounded-xl bg-slate-50 text-slate-700"><Icons.Users /></div></div>
                       <div className="overflow-hidden rounded-xl border border-slate-100">
                          <table className="min-w-full text-center text-[11px] font-bold uppercase tracking-tight">
                             <thead className="bg-slate-50 text-slate-400 border-b">
                                <tr><th className="px-4 py-3 border-r">Jantina</th><th className="px-4 py-3 border-r text-indigo-600">7 Tahun</th><th className="px-4 py-3 border-r text-orange-600">6 Tahun</th><th className="px-4 py-3 bg-slate-100 text-slate-900">Jumlah</th></tr>
                             </thead>
                             <tbody className="divide-y divide-slate-50">
                                <tr className="hover:bg-slate-50/50"><td className="px-4 py-4 text-slate-800 border-r text-left">Lelaki</td><td className="px-4 py-4 border-r">{stats.cohortValues.c7_m}</td><td className="px-4 py-4 border-r">{stats.cohortValues.c6_m}</td><td className="px-4 py-4 bg-slate-50 text-blue-600 font-black">{stats.cohortValues.total_m}</td></tr>
                                <tr className="hover:bg-slate-50/50"><td className="px-4 py-4 text-slate-800 border-r text-left">Perempuan</td><td className="px-4 py-4 border-r">{stats.cohortValues.c7_p}</td><td className="px-4 py-4 border-r">{stats.cohortValues.c6_p}</td><td className="px-4 py-4 bg-slate-50 text-pink-600 font-black">{stats.cohortValues.total_p}</td></tr>
                                <tr className="bg-slate-100 font-black"><td className="px-4 py-4 text-slate-900 border-r text-left">Jumlah</td><td className="px-4 py-4 border-r">{stats.cohortValues.c7_total}</td><td className="px-4 py-4 border-r">{stats.cohortValues.c6_total}</td><td className="px-4 py-4 bg-slate-900 text-white font-black">{stats.cohortValues.grand_total}</td></tr>
                             </tbody>
                          </table>
                       </div>
                    </div>
                    <div className="premium-card p-6 flex flex-col h-full"><div className="flex justify-between items-center mb-6"><p className="text-sm font-bold text-slate-500 uppercase tracking-wider text-left">Pecahan Jantina</p><div className="p-2.5 rounded-xl bg-slate-50 text-slate-700"><Icons.CheckCircle /></div></div><div className="h-40"><Chart.ResponsiveContainer width="100%" height="100%"><Chart.BarChart data={stats.genderData} margin={{top: 25, right: 10, left: 10, bottom: 0}}><Chart.CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0"/><Chart.XAxis dataKey="name" tick={{fontSize: 11, fontWeight: 600, fill: '#64748b'}} axisLine={false} tickLine={false} /><Chart.Bar dataKey="value" radius={[4,4,0,0]} barSize={32}>{stats.genderData.map((e, i) => <Chart.Cell key={i} fill={e.color} />)}<Chart.LabelList dataKey="value" position="top" fontSize={12} fontWeight={800} fill="#1e293b" /></Chart.Bar></Chart.BarChart></Chart.ResponsiveContainer></div></div>
                  </div>

                  <div className="premium-card overflow-hidden bg-white">
                    <div className="p-8 border-b flex flex-col md:flex-row justify-between items-center gap-6 bg-slate-50/50 no-print">
                      <div className="text-left w-full md:w-auto"><h3 className="text-base font-extrabold text-slate-900 uppercase tracking-widest">Rumusan Per Daerah Sarawak</h3><p className="text-xs font-semibold text-slate-500 mt-1 uppercase">Pecahan Bilangan Murid Mengikut Kohort</p></div>
                      <div className="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center font-black">
                         <button onClick={handleCopyTable} className="px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-[10px] font-bold text-slate-700 hover:bg-slate-50 hover:text-blue-600 transition-all shadow-sm uppercase tracking-widest leading-none"><Icons.Copy className="w-4 h-4" /> Salin Jadual</button>
                         <div className="relative w-full md:w-64">
                            <Icons.Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" /><input type="text" placeholder="Cari Daerah PPD..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-[10px] font-bold text-slate-700 outline-none focus:ring-2 focus:ring-slate-800 transition-all shadow-sm uppercase" />
                         </div>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="min-w-full text-center uppercase font-bold text-[10px]">
                        <thead>
                          <tr>
                            <th rowSpan="2" className="border-r border-b px-4 py-4 text-slate-400 tracking-wider">Bil</th>
                            <th rowSpan="2" className="text-left border-r border-b px-6 py-4 text-slate-500 tracking-wider w-1/4">Nama PPD</th>
                            <th rowSpan="2" className="bg-slate-100/50 border-r border-b px-6 py-4 text-slate-900 tracking-wider">Jumlah</th>
                            <th colSpan="3" className="bg-orange-50/50 border-b border-r px-6 py-3 text-slate-600 tracking-wider font-black">Kohort 7 Thn (6+)</th>
                            <th colSpan="3" className="bg-blue-50/50 border-b border-r px-6 py-3 text-slate-600 tracking-wider font-black">Kohort 6 Thn (5+)</th>
                            <th rowSpan="2" className="border-b px-6 py-4 text-slate-400 tracking-wider action-col">Tindakan</th>
                          </tr>
                          <tr className="bg-slate-50/30 text-slate-500">
                             <th className="border-r border-b py-3 px-4">L</th><th className="border-r border-b py-3 px-4">P</th>
                             <th className="border-r border-b py-3 px-4 text-orange-700 bg-orange-50/50 font-black">Jum</th>
                             <th className="border-r border-b py-3 px-4">L</th><th className="border-r border-b py-3 px-4">P</th>
                             <th className="border-r border-b py-3 px-4 text-blue-700 bg-blue-50/50 font-black">Jum</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 text-[11px] font-bold">
                          {filteredPPDList.map((p, i) => (
                            <tr key={p.name} className="hover:bg-slate-50/80 transition-colors">
                              <td className="text-slate-300 text-center border-r py-3.5">{i+1}</td>
                              <td className="text-left text-slate-800 font-black border-r py-3.5 px-6">PPD {p.name}</td>
                              <td className="bg-slate-50/30 text-slate-950 border-r font-black py-3.5 text-base">{p.total}</td>
                              <td className="text-blue-600 border-r py-3.5">{p.c7_l}</td><td className="text-pink-600 border-r py-3.5">{p.c7_p}</td>
                              <td className="text-orange-700 border-r py-3.5 font-black bg-orange-50/20">{p.c7_l + p.c7_p}</td>
                              <td className="text-blue-600 border-r py-3.5">{p.c6_l}</td><td className="text-pink-600 border-r py-3.5">{p.c6_p}</td>
                              <td className="text-blue-700 border-r py-3.5 font-black bg-blue-50/20">{p.c6_l + p.c6_p}</td>
                              <td className="py-3.5 action-col">
                                <button onClick={() => setDeleteConfirm({ show: true, ppd: p.name })} className="p-2.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-600 hover:text-white transition-all shadow-sm active:scale-95 group">
                                  <Icons.Trash2 className="w-4 h-4 group-hover:scale-110 transition-transform" />
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'list' && (
                <div className="max-w-3xl mx-auto space-y-10 no-print animate-fade-in uppercase font-black">
                  <div className="premium-card p-12 text-center space-y-8">
                    <div className="mb-8 w-full max-w-sm mx-auto font-bold uppercase">
                      <label className="block text-[10px] font-bold text-slate-400 tracking-widest mb-3 uppercase leading-none">Langkah 1: Pilih PPD Utama</label>
                      <select value={manualPPD} onChange={(e) => setManualPPD(e.target.value)} className="w-full px-6 py-4 bg-slate-50 text-xs font-black rounded-2xl border border-slate-200 outline-none focus:border-red-500 transition-all cursor-pointer text-center uppercase tracking-widest shadow-inner"><option value="">-- SILAH PILIH DAERAH PPD --</option>{PPD_LIST.map(p => <option key={p} value={p}>PPD {p}</option>)}</select>
                    </div>
                    
                    <div className={`relative group p-14 border-4 border-dashed rounded-[3rem] transition-all ${manualPPD ? 'border-slate-200 hover:bg-slate-50 cursor-pointer' : 'border-slate-100 bg-slate-50 opacity-50 cursor-not-allowed'}`}>
                      {manualPPD && <input type="file" accept=".csv,.xlsx,.xls" onChange={(e)=>{ const file = e.target.files[0]; if (file) { const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls'); const reader = new FileReader(); reader.onload = (ev) => { if(isExcel) { const workbook = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}); const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); handleProcessData(rows, true); } else { handleProcessData(ev.target.result, false); } }; if(isExcel) reader.readAsArrayBuffer(file); else reader.readAsText(file); } }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />}
                      <div className="w-20 h-20 bg-slate-900 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl"><Icons.Upload /></div>
                      <h3 className="text-xl font-black text-slate-900 leading-tight">MUAT NAIK FAIL DATA</h3>
                      <p className="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-2 uppercase">Sokongan Fail: Excel (.xlsx) atau CSV</p>
                      {!manualPPD && <p className="mt-4 text-red-500 text-[9px] font-black italic">! Sila Pilih PPD di atas terlebih dahulu</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-6 pt-10 border-t border-slate-100">
                      <button onClick={handleDownloadCSV} className="bg-slate-900 text-white py-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-black transition-all flex items-center justify-center gap-3 shadow-lg"><Icons.Download /> Muat Turun CSV</button>
                      <button onClick={() => setResetConfirm(true)} className="bg-red-50 text-red-600 py-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-red-100 transition-all border border-red-200 flex items-center justify-center gap-3 leading-none font-black"><Icons.Trash2 /> Padam Semua Data</button>
                    </div>

                    <div className="pt-4">
                       <button onClick={() => setCleanupConfirm(true)} className="w-full py-4 bg-orange-50 text-orange-700 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-orange-100 border border-orange-200 transition-all flex items-center justify-center gap-2 font-black leading-none"><Icons.ShieldAlert /> Bersihkan Rekod Tidak Sah</button>
                    </div>
                  </div>

                  <div className="premium-card p-10 bg-white text-left shadow-lg font-['Plus Jakarta Sans'] font-bold uppercase">
                     <h3 className="text-sm font-bold text-slate-900 tracking-widest mb-8 border-b pb-4 flex items-center gap-3"><Icons.CheckCircle className="text-emerald-500 w-5 h-5"/> Status Penghantaran Data PPD</h3>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                       <div><h4 className="text-[10px] font-bold text-emerald-600 uppercase mb-4 tracking-widest leading-none">Sudah Muat Naik ({sudahMuatNaik.length}/30)</h4><div className="grid grid-cols-2 gap-3">{sudahMuatNaik.map(p => (<div key={p} className="text-[9px] font-bold text-slate-700 bg-emerald-50 py-2.5 px-3 rounded-lg border border-emerald-100 flex justify-between items-center">{p} <Icons.CheckCircle className="w-3 h-3 text-emerald-500" /></div>))}</div></div>
                       <div><h4 className="text-[10px] font-bold text-red-500 uppercase mb-4 tracking-widest leading-none">Belum Muat Naik ({belumMuatNaik.length}/30)</h4><div className="grid grid-cols-2 gap-3">{belumMuatNaik.map(p => (<div key={p} className="text-[9px] font-bold text-slate-500 bg-slate-50 py-2.5 px-3 rounded-lg border border-slate-100 flex justify-between items-center">{p} <Icons.XCircle className="w-3 h-3 text-red-300" /></div>))}</div></div>
                     </div>
                  </div>
                </div>
              )}

              {activeTab === 'info' && (
                <div className="max-w-4xl mx-auto animate-fade-in no-print font-['Plus Jakarta Sans'] font-bold uppercase">
                   <div className="premium-card p-12 space-y-10 text-left">
                      <div className="flex items-center gap-4 border-b border-slate-100 pb-8"><div className="w-14 h-14 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-800"><Icons.Info className="w-6 h-6"/></div><h2 className="text-2xl font-extrabold text-slate-900 tracking-tighter uppercase leading-none">Maklumat Pengurusan Sistem</h2></div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-10 text-[11px] leading-relaxed text-slate-600">
                         <div className="space-y-3"><h4 className="text-slate-900 font-bold tracking-widest uppercase text-xs">1. Konsolidasi Data</h4><p>Sistem menggabungkan data permohonan dari setiap daerah Sarawak secara unik berasaskan No. MyKid murid bagi menjamin ketepatan statistik.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 font-bold tracking-widest uppercase text-xs">2. Kawalan Integriti</h4><p>Fungsi pemadaman disediakan secara spesifik bagi setiap PPD melalui Dashboard untuk memudahkan pembetulan data daerah tanpa mengganggu daerah lain.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 font-bold tracking-widest uppercase text-xs">3. Jantina Mutlak</h4><p>Logik sistem memproses jantina murid secara automatik berpandukan digit ke-12 No. MyKid (Ganjil=Lelaki, Genap=Perempuan) bagi menjamin ketepatan 100%.</p></div>
                         <div className="space-y-3"><h4 className="text-slate-900 font-bold tracking-widest uppercase text-xs">4. Kohort Umur</h4><p>Sistem secara automatik mengasingkan murid mengikut kumpulan umur berdasarkan tarikh lahir yang diekstrak dari No. MyKid.</p></div>
                      </div>
                   </div>
                </div>
              )}
            </main>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    }

    function parseDataInputCSV(text) {
        const lines = text.split(/\r\n|\n/);
        const headers = lines[0].split(lines[0].includes('\t') ? '\t' : ',').map(h => h.trim().replace(/^"|"$/g, ''));
        return lines.slice(1).map(line => {
            const cols = line.split(line.includes('\t') ? '\t' : ',');
            const obj = {};
            headers.forEach((h, i) => { obj[h] = cols[i] ? cols[i].trim().replace(/^"|"$/g, '') : ''; });
            return obj;
        });
    }

    window.onload = initApp;
  </script>
</body>
</html>
